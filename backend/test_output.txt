============================= test session starts ==============================
platform linux -- Python 3.13.8, pytest-8.3.4, pluggy-1.6.0
rootdir: /home/user/deeps/backend
configfile: pytest.ini
testpaths: tests
plugins: langsmith-0.4.43, anyio-4.11.0, cov-6.0.0, asyncio-0.24.0
asyncio: mode=Mode.AUTO, default_loop_scope=function
collected 649 items

tests/test_api/test_advanced_config.py ................................. [  5%]
..                                                                       [  5%]
tests/test_api/test_agents.py ..................F.........               [  9%]
tests/test_api/test_analytics_endpoints.py FF..............              [ 12%]
tests/test_api/test_auth.py ..................FFFFF.FFF                  [ 16%]
tests/test_api/test_executions.py ....FF....                             [ 17%]
tests/test_api/test_monitoring.py ..FF...............                    [ 20%]
tests/test_api/test_subagent_endpoints.py ...................            [ 23%]
tests/test_api/test_templates.py .......................                 [ 27%]
tests/test_api/test_tools.py .............................               [ 31%]
tests/test_api/test_users.py ............                                [ 33%]
tests/test_core/test_config.py .........                                 [ 34%]
tests/test_core/test_dependencies.py ..........                          [ 36%]
tests/test_core/test_password_validator.py ......................F...... [ 40%]
............                                                             [ 42%]
tests/test_core/test_path_validator.py ..........F.........F............ [ 47%]
..........F.........F                                                    [ 51%]
tests/test_core/test_security.py ............                            [ 53%]
tests/test_deepagents_integration/test_backends.py ..................... [ 56%]
.                                                                        [ 56%]
tests/test_deepagents_integration/test_factory.py ..........FF.........  [ 59%]
tests/test_deepagents_integration/test_factory_advanced.py ............. [ 61%]
.                                                                        [ 61%]
tests/test_deepagents_integration/test_filesystem.py ...............     [ 64%]
tests/test_deepagents_integration/test_planning.py ..........            [ 65%]
tests/test_deepagents_integration/test_store.py ........................ [ 69%]
                                                                         [ 69%]
tests/test_main.py .................                                     [ 71%]
tests/test_services/test_agent_service.py ..........................     [ 75%]
tests/test_services/test_analytics_service.py FFF.................       [ 79%]
tests/test_services/test_auth_service.py .......FF...F.....              [ 81%]
tests/test_services/test_execution_service.py ............               [ 83%]
tests/test_services/test_lockout_service.py ......................       [ 87%]
tests/test_services/test_monitoring_service.py ...FF..F...F..F.....      [ 90%]
tests/test_services/test_subagent_service.py ...................         [ 93%]
tests/test_services/test_template_service.py .....................       [ 96%]
tests/test_services/test_tool_service.py ........................        [100%]

=================================== FAILURES ===================================
____________________ test_delete_agent_endpoint_idempotent _____________________
tests/test_api/test_agents.py:400: in test_delete_agent_endpoint_idempotent
    assert response.status_code == 204
E   assert 404 == 204
E    +  where 404 = <Response [404 Not Found]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:09:56.617 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:09:56.617 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:09:56.617 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:09:56.619 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:09:56.625 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:09:56.634 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:09:56.636 | WARNING  | main:http_exception_handler:107 - HTTP 404 error: Agent with id 1 not found - http://testserver/api/v1/agents/1
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:09:59.228 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:09:59.229 | INFO     | main:lifespan:53 - Database connections closed
________ TestTimeSeriesEndpoint.test_get_execution_time_series_endpoint ________
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlite3.OperationalError: no such function: date_trunc

The above exception was the direct cause of the following exception:
tests/test_api/test_analytics_endpoints.py:54: in test_get_execution_time_series_endpoint
    response = client.get(
venv/lib/python3.13/site-packages/starlette/testclient.py:473: in get
    return super().get(
venv/lib/python3.13/site-packages/httpx/_client.py:1053: in get
    return self.request(
venv/lib/python3.13/site-packages/starlette/testclient.py:445: in request
    return super().request(
venv/lib/python3.13/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.13/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.13/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.13/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.13/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.13/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
venv/lib/python3.13/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/middleware.py:53: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/rate_limit.py:282: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
venv/lib/python3.13/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.13/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
api/v1/analytics.py:68: in get_execution_time_series
    data = await analytics_service.get_execution_time_series(
core/cache.py:141: in wrapper
    result = await func(*args, **kwargs)
services/analytics_service.py:95: in get_execution_time_series
    result = await db.execute(query)
venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such function: date_trunc
E   [SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
E   FROM executions 
E   WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL GROUP BY bucket ORDER BY bucket]
E   [parameters: ('day', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-17 22:10:00.202753', '2025-11-19 23:10:00.202753')]
E   (Background on this error at: https://sqlalche.me/e/20/e3q8)
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:00.195 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:00.195 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:00.195 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:00.198 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:00.207 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:00.208 | WARNING  | core.cache:_make_cache_key:83 - Failed to serialize cache key arguments: Circular reference detected
2025-11-19 22:10:00.210 | WARNING  | core.cache:wrapper:137 - Redis cache read error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:00.220 | ERROR    | core.middleware:dispatch:92 - Request error: GET /api/v1/analytics/executions/time-series failed after 0.01s: (sqlite3.OperationalError) no such function: date_trunc
[SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
FROM executions 
WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL GROUP BY bucket ORDER BY bucket]
[parameters: ('day', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-17 22:10:00.202753', '2025-11-19 23:10:00.202753')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-11-19 22:10:00.221 | ERROR    | main:generic_exception_handler:170 - Unexpected error on http://testserver/api/v1/analytics/executions/time-series?start_date=2025-11-17T22%3A10%3A00.202753&end_date=2025-11-19T23%3A10%3A00.202753&interval=day: (sqlite3.OperationalError) no such function: date_trunc
[SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
FROM executions 
WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL GROUP BY bucket ORDER BY bucket]
[parameters: ('day', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-17 22:10:00.202753', '2025-11-19 23:10:00.202753')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:00.973 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:00.974 | INFO     | main:lifespan:53 - Database connections closed
_ TestTimeSeriesEndpoint.test_get_execution_time_series_endpoint_with_agent_filter _
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlite3.OperationalError: no such function: date_trunc

The above exception was the direct cause of the following exception:
tests/test_api/test_analytics_endpoints.py:93: in test_get_execution_time_series_endpoint_with_agent_filter
    response = client.get(
venv/lib/python3.13/site-packages/starlette/testclient.py:473: in get
    return super().get(
venv/lib/python3.13/site-packages/httpx/_client.py:1053: in get
    return self.request(
venv/lib/python3.13/site-packages/starlette/testclient.py:445: in request
    return super().request(
venv/lib/python3.13/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.13/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.13/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.13/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.13/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.13/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
venv/lib/python3.13/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/middleware.py:53: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/rate_limit.py:282: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
venv/lib/python3.13/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.13/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
api/v1/analytics.py:68: in get_execution_time_series
    data = await analytics_service.get_execution_time_series(
core/cache.py:141: in wrapper
    result = await func(*args, **kwargs)
services/analytics_service.py:95: in get_execution_time_series
    result = await db.execute(query)
venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such function: date_trunc
E   [SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
E   FROM executions 
E   WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL AND executions.agent_id = ? GROUP BY bucket ORDER BY bucket]
E   [parameters: ('hour', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-19 21:10:01.050917', '2025-11-19 23:10:01.050917', 1)]
E   (Background on this error at: https://sqlalche.me/e/20/e3q8)
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:01.045 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:01.045 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:01.045 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:01.047 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:01.054 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:01.055 | WARNING  | core.cache:_make_cache_key:83 - Failed to serialize cache key arguments: Circular reference detected
2025-11-19 22:10:01.056 | WARNING  | core.cache:wrapper:137 - Redis cache read error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:01.060 | ERROR    | core.middleware:dispatch:92 - Request error: GET /api/v1/analytics/executions/time-series failed after 0.01s: (sqlite3.OperationalError) no such function: date_trunc
[SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
FROM executions 
WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL AND executions.agent_id = ? GROUP BY bucket ORDER BY bucket]
[parameters: ('hour', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-19 21:10:01.050917', '2025-11-19 23:10:01.050917', 1)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-11-19 22:10:01.061 | ERROR    | main:generic_exception_handler:170 - Unexpected error on http://testserver/api/v1/analytics/executions/time-series?start_date=2025-11-19T21%3A10%3A01.050917&end_date=2025-11-19T23%3A10%3A01.050917&interval=hour&agent_id=1: (sqlite3.OperationalError) no such function: date_trunc
[SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
FROM executions 
WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL AND executions.agent_id = ? GROUP BY bucket ORDER BY bucket]
[parameters: ('hour', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-19 21:10:01.050917', '2025-11-19 23:10:01.050917', 1)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:01.552 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:01.552 | INFO     | main:lifespan:53 - Database connections closed
_________________ test_get_lockout_status_with_failed_attempts _________________
tests/test_api/test_auth.py:360: in test_get_lockout_status_with_failed_attempts
    assert data["failed_attempts"] == 2
E   assert 0 == 2
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:10.241 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:10.241 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:10.241 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:10.243 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:10.247 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.249 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.514 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.514 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:10.514 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:10.516 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.518 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.782 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.782 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:10.783 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:10.785 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:10.786 | WARNING  | services.lockout_service:get_lockout_status:326 - Redis error in get_lockout_status: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:10.798 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:10.798 | INFO     | main:lifespan:53 - Database connections closed
____________________ test_get_lockout_status_locked_account ____________________
tests/test_api/test_auth.py:383: in test_get_lockout_status_locked_account
    assert data["locked"] is True
E   assert False is True
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:11.128 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:11.128 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:11.128 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:11.130 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:11.134 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.135 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.400 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.400 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:11.400 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:11.402 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.404 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.671 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.671 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:11.671 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:11.674 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.675 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.941 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.941 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:11.942 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:11.944 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:11.946 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.212 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.212 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:12.212 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:12.214 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.215 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.480 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.480 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:12.481 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:12.483 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.484 | WARNING  | services.lockout_service:get_lockout_status:326 - Redis error in get_lockout_status: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:12.495 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:12.496 | INFO     | main:lifespan:53 - Database connections closed
_______________ test_get_lockout_status_requires_authentication ________________
tests/test_api/test_auth.py:395: in test_get_lockout_status_requires_authentication
    assert response.status_code == 403  # Forbidden without auth
E   assert 200 == 403
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:12.850 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:12.850 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:12.850 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:12.853 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:12.855 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:12.857 | WARNING  | services.lockout_service:get_lockout_status:326 - Redis error in get_lockout_status: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:12.869 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:12.870 | INFO     | main:lifespan:53 - Database connections closed
__________________________ test_unlock_locked_account __________________________
tests/test_api/test_auth.py:419: in test_unlock_locked_account
    assert response.json()["locked"] is True
E   assert False is True
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:13.208 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:13.208 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:13.208 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:13.210 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:13.214 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.216 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.482 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.482 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:13.482 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:13.485 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.486 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.751 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.751 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:13.751 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:13.753 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:13.755 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.023 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.023 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:14.023 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:14.025 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.026 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.291 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.291 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:14.291 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:14.293 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.295 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.561 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.561 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:14.561 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:14.563 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.564 | WARNING  | services.lockout_service:get_lockout_status:326 - Redis error in get_lockout_status: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:14.576 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:14.577 | INFO     | main:lifespan:53 - Database connections closed
_____________________ test_unlock_already_unlocked_account _____________________
tests/test_api/test_auth.py:456: in test_unlock_already_unlocked_account
    assert response.status_code == 200
E   assert 403 == 200
E    +  where 403 = <Response [403 Forbidden]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:14.922 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:14.922 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:14.922 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:14.924 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:14.928 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:14.929 | WARNING  | main:http_exception_handler:107 - HTTP 403 error: Admin privileges required - http://testserver/api/v1/auth/unlock-account/testuser
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:14.940 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:14.941 | INFO     | main:lifespan:53 - Database connections closed
_________________________ test_unlock_nonexistent_user _________________________
tests/test_api/test_auth.py:481: in test_unlock_nonexistent_user
    assert response.status_code == 200
E   assert 403 == 200
E    +  where 403 = <Response [403 Forbidden]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:15.627 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:15.627 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:15.627 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:15.630 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:15.635 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:15.636 | WARNING  | main:http_exception_handler:107 - HTTP 403 error: Admin privileges required - http://testserver/api/v1/auth/unlock-account/nonexistent_user
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:15.647 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:15.648 | INFO     | main:lifespan:53 - Database connections closed
____________________ test_login_locked_account_returns_429 _____________________
tests/test_api/test_auth.py:508: in test_login_locked_account_returns_429
    assert response.status_code == 429  # Too Many Requests
E   assert 200 == 429
E    +  where 200 = <Response [200 OK]>.status_code
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:15.990 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:15.990 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:15.990 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:15.992 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:15.995 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:15.997 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.261 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.262 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:16.262 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:16.264 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.266 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.531 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.532 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:16.532 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:16.534 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.536 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.810 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.810 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:16.810 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:16.812 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:16.814 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.080 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.080 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:17.080 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:17.082 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.084 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.349 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.349 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:17.349 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:17.351 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.353 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.618 | WARNING  | services.lockout_service:record_successful_login:242 - Redis error in record_successful_login: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.618 | INFO     | services.auth_service:authenticate_user:145 - Successful login for user 'testuser'.
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:17.632 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:17.633 | INFO     | main:lifespan:53 - Database connections closed
_________________ test_successful_login_clears_failed_attempts _________________
tests/test_api/test_auth.py:530: in test_successful_login_clears_failed_attempts
    assert status["failed_attempts"] == 3
E   assert 0 == 3
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:17.976 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:17.976 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:17.976 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:17.979 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:17.983 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:17.984 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.249 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.249 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:18.249 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:18.252 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.253 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.521 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.521 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:18.521 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:18.523 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.525 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.794 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.794 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'testuser'. 5 attempts remaining.
2025-11-19 22:10:18.794 | WARNING  | main:http_exception_handler:107 - HTTP 401 error: Incorrect username or password - http://testserver/api/v1/auth/login
2025-11-19 22:10:18.796 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:18.797 | WARNING  | services.lockout_service:get_lockout_status:326 - Redis error in get_lockout_status: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:18.808 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:18.809 | INFO     | main:lifespan:53 - Database connections closed
___________ TestExecutionAPIEndpoints.test_list_executions_endpoint ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
  |     yield
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 192, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/capture.py", line 880, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |     ~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 457, in runtest
    |     super().runtest()
    |     ~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 929, in inner
    |     _loop.run_until_complete(task)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
    |   File "/usr/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    |     return future.result()
    |            ~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/tests/test_api/test_executions.py", line 143, in test_list_executions_endpoint
    |     response = client.get("/api/v1/executions/")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 473, in get
    |     return super().get(
    |            ~~~~~~~~~~~^
    |         url,
    |         ^^^^
    |     ...<6 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ~~~~~~~~~~~~^
    |         "GET",
    |         ^^^^^^
    |     ...<7 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 445, in request
    |     return super().request(
    |            ~~~~~~~~~~~~~~~^
    |         method,
    |         ^^^^^^^
    |     ...<11 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |         request,
    |     ...<2 lines>...
    |         history=[],
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |         request,
    |         follow_redirects=follow_redirects,
    |         history=history,
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 348, in handle_request
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 345, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |     ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 321, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 252, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1134, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/middleware.py", line 53, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/rate_limit.py", line 282, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 125, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 111, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 391, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 290, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/api/v1/executions.py", line 273, in list_executions
    |     executions = await execution_service.list_executions(
    |                        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
    |         db=db,
    |         ^^^^^^
    |     ...<4 lines>...
    |         user_id=current_user.id,  # Filter by current user
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    | TypeError: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
    +------------------------------------

The above exception was the direct cause of the following exception:
tests/test_api/test_executions.py:143: in test_list_executions_endpoint
    response = client.get("/api/v1/executions/")
venv/lib/python3.13/site-packages/starlette/testclient.py:473: in get
    return super().get(
venv/lib/python3.13/site-packages/httpx/_client.py:1053: in get
    return self.request(
venv/lib/python3.13/site-packages/starlette/testclient.py:445: in request
    return super().request(
venv/lib/python3.13/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.13/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.13/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.13/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.13/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.13/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
venv/lib/python3.13/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/middleware.py:53: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/rate_limit.py:282: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
venv/lib/python3.13/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.13/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
api/v1/executions.py:273: in list_executions
    executions = await execution_service.list_executions(
E   TypeError: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:19.226 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:19.226 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:19.227 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:19.229 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:19.237 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:19.238 | ERROR    | core.middleware:dispatch:92 - Request error: GET /api/v1/executions/ failed after 0.00s: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
2025-11-19 22:10:19.238 | ERROR    | main:generic_exception_handler:170 - Unexpected error on http://testserver/api/v1/executions/: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:19.498 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:19.499 | INFO     | main:lifespan:53 - Database connections closed
_________ TestExecutionAPIEndpoints.test_list_executions_with_filters __________
  + Exception Group Traceback (most recent call last):
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
  |     yield
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 192, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/capture.py", line 880, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |     ~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 457, in runtest
    |     super().runtest()
    |     ~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 929, in inner
    |     _loop.run_until_complete(task)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
    |   File "/usr/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    |     return future.result()
    |            ~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/tests/test_api/test_executions.py", line 190, in test_list_executions_with_filters
    |     response = client.get(f"/api/v1/executions/?agent_id={agent1.id}")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 473, in get
    |     return super().get(
    |            ~~~~~~~~~~~^
    |         url,
    |         ^^^^
    |     ...<6 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ~~~~~~~~~~~~^
    |         "GET",
    |         ^^^^^^
    |     ...<7 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 445, in request
    |     return super().request(
    |            ~~~~~~~~~~~~~~~^
    |         method,
    |         ^^^^^^^
    |     ...<11 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |         request,
    |     ...<2 lines>...
    |         history=[],
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |         request,
    |         follow_redirects=follow_redirects,
    |         history=history,
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 348, in handle_request
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 345, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |     ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 321, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 252, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1134, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/middleware.py", line 53, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/rate_limit.py", line 282, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 125, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 111, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 391, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 290, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/api/v1/executions.py", line 273, in list_executions
    |     executions = await execution_service.list_executions(
    |                        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
    |         db=db,
    |         ^^^^^^
    |     ...<4 lines>...
    |         user_id=current_user.id,  # Filter by current user
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    | TypeError: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
    +------------------------------------

The above exception was the direct cause of the following exception:
tests/test_api/test_executions.py:190: in test_list_executions_with_filters
    response = client.get(f"/api/v1/executions/?agent_id={agent1.id}")
venv/lib/python3.13/site-packages/starlette/testclient.py:473: in get
    return super().get(
venv/lib/python3.13/site-packages/httpx/_client.py:1053: in get
    return self.request(
venv/lib/python3.13/site-packages/starlette/testclient.py:445: in request
    return super().request(
venv/lib/python3.13/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.13/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.13/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.13/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.13/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.13/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
venv/lib/python3.13/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/middleware.py:53: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/rate_limit.py:282: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
venv/lib/python3.13/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.13/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
api/v1/executions.py:273: in list_executions
    executions = await execution_service.list_executions(
E   TypeError: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:19.570 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:19.570 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:19.570 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:19.572 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:19.580 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:19.582 | ERROR    | core.middleware:dispatch:92 - Request error: GET /api/v1/executions/ failed after 0.00s: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
2025-11-19 22:10:19.582 | ERROR    | main:generic_exception_handler:170 - Unexpected error on http://testserver/api/v1/executions/?agent_id=1: ExecutionService.list_executions() got an unexpected keyword argument 'user_id'
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:19.844 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:19.845 | INFO     | main:lifespan:53 - Database connections closed
____________ TestAgentHealthEndpoint.test_get_agent_health_endpoint ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
  |     yield
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 192, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/capture.py", line 880, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |     ~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 457, in runtest
    |     super().runtest()
    |     ~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 929, in inner
    |     _loop.run_until_complete(task)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
    |   File "/usr/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    |     return future.result()
    |            ~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/tests/test_api/test_monitoring.py", line 116, in test_get_agent_health_endpoint
    |     response = client.get("/api/v1/monitoring/agents/health")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 473, in get
    |     return super().get(
    |            ~~~~~~~~~~~^
    |         url,
    |         ^^^^
    |     ...<6 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ~~~~~~~~~~~~^
    |         "GET",
    |         ^^^^^^
    |     ...<7 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 445, in request
    |     return super().request(
    |            ~~~~~~~~~~~~~~~^
    |         method,
    |         ^^^^^^^
    |     ...<11 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |         request,
    |     ...<2 lines>...
    |         history=[],
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |         request,
    |         follow_redirects=follow_redirects,
    |         history=history,
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 348, in handle_request
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 345, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |     ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 321, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 252, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1134, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/middleware.py", line 53, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/rate_limit.py", line 282, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 125, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 111, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 391, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 290, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/api/v1/monitoring.py", line 90, in get_agent_health
    |     health_data = await monitoring_service.get_agent_health(db, agent_id)
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/services/monitoring_service.py", line 160, in get_agent_health
    |     func.case((Execution.status == "completed", 1), else_=0)
    |     ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py", line 976, in __call__
    |     return Function(
    |         self.__names[-1], packagenames=tuple(self.__names[0:-1]), *c, **o
    |     )
    | TypeError: Function.__init__() got an unexpected keyword argument 'else_'
    +------------------------------------

The above exception was the direct cause of the following exception:
tests/test_api/test_monitoring.py:116: in test_get_agent_health_endpoint
    response = client.get("/api/v1/monitoring/agents/health")
venv/lib/python3.13/site-packages/starlette/testclient.py:473: in get
    return super().get(
venv/lib/python3.13/site-packages/httpx/_client.py:1053: in get
    return self.request(
venv/lib/python3.13/site-packages/starlette/testclient.py:445: in request
    return super().request(
venv/lib/python3.13/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.13/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.13/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.13/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.13/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.13/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
venv/lib/python3.13/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/middleware.py:53: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/rate_limit.py:282: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
venv/lib/python3.13/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.13/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
api/v1/monitoring.py:90: in get_agent_health
    health_data = await monitoring_service.get_agent_health(db, agent_id)
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:20.454 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:20.454 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:20.454 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:20.456 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:20.464 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:20.467 | ERROR    | core.middleware:dispatch:92 - Request error: GET /api/v1/monitoring/agents/health failed after 0.00s: Function.__init__() got an unexpected keyword argument 'else_'
2025-11-19 22:10:20.467 | ERROR    | main:generic_exception_handler:170 - Unexpected error on http://testserver/api/v1/monitoring/agents/health: Function.__init__() got an unexpected keyword argument 'else_'
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:20.748 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:20.749 | INFO     | main:lifespan:53 - Database connections closed
_____ TestAgentHealthEndpoint.test_get_agent_health_endpoint_with_agent_id _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
  |     yield
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 192, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 781, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: TResult | None = func()
    |                              ~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 242, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 846, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/logging.py", line 829, in _runtest_for
    |     yield
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/capture.py", line 880, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    |     item.runtest()
    |     ~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 457, in runtest
    |     super().runtest()
    |     ~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 1627, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |     ~~~~~~~~~~~~~~^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py", line 929, in inner
    |     _loop.run_until_complete(task)
    |     ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
    |   File "/usr/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    |     return future.result()
    |            ~~~~~~~~~~~~~^^
    |   File "/home/user/deeps/backend/tests/test_api/test_monitoring.py", line 176, in test_get_agent_health_endpoint_with_agent_id
    |     response = client.get(
    |         f"/api/v1/monitoring/agents/health?agent_id={test_agent.id}"
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 473, in get
    |     return super().get(
    |            ~~~~~~~~~~~^
    |         url,
    |         ^^^^
    |     ...<6 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ~~~~~~~~~~~~^
    |         "GET",
    |         ^^^^^^
    |     ...<7 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 445, in request
    |     return super().request(
    |            ~~~~~~~~~~~~~~~^
    |         method,
    |         ^^^^^^^
    |     ...<11 lines>...
    |         extensions=extensions,
    |         ^^^^^^^^^^^^^^^^^^^^^^
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |         request,
    |     ...<2 lines>...
    |         history=[],
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |         request,
    |         follow_redirects=follow_redirects,
    |         history=history,
    |     )
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 348, in handle_request
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/testclient.py", line 345, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |     ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 321, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/anyio/from_thread.py", line 252, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1134, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/applications.py", line 107, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/middleware.py", line 53, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/usr/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/core/rate_limit.py", line 282, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 125, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 111, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 391, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |     ...<3 lines>...
    |     )
    |     ^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/fastapi/routing.py", line 290, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/api/v1/monitoring.py", line 90, in get_agent_health
    |     health_data = await monitoring_service.get_agent_health(db, agent_id)
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/services/monitoring_service.py", line 160, in get_agent_health
    |     func.case((Execution.status == "completed", 1), else_=0)
    |     ~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/user/deeps/backend/venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py", line 976, in __call__
    |     return Function(
    |         self.__names[-1], packagenames=tuple(self.__names[0:-1]), *c, **o
    |     )
    | TypeError: Function.__init__() got an unexpected keyword argument 'else_'
    +------------------------------------

The above exception was the direct cause of the following exception:
tests/test_api/test_monitoring.py:176: in test_get_agent_health_endpoint_with_agent_id
    response = client.get(
venv/lib/python3.13/site-packages/starlette/testclient.py:473: in get
    return super().get(
venv/lib/python3.13/site-packages/httpx/_client.py:1053: in get
    return self.request(
venv/lib/python3.13/site-packages/starlette/testclient.py:445: in request
    return super().request(
venv/lib/python3.13/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.13/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.13/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.13/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.13/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.13/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
venv/lib/python3.13/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.13/site-packages/anyio/from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.13/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.13/site-packages/anyio/from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.13/site-packages/fastapi/applications.py:1134: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/middleware.py:53: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
/usr/lib/python3.13/contextlib.py:162: in __exit__
    self.gen.throw(value)
venv/lib/python3.13/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
venv/lib/python3.13/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
core/rate_limit.py:282: in dispatch
    response = await call_next(request)
venv/lib/python3.13/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv/lib/python3.13/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.13/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
venv/lib/python3.13/site-packages/fastapi/routing.py:125: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.13/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.13/site-packages/fastapi/routing.py:111: in app
    response = await f(request)
venv/lib/python3.13/site-packages/fastapi/routing.py:391: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.13/site-packages/fastapi/routing.py:290: in run_endpoint_function
    return await dependant.call(**values)
api/v1/monitoring.py:90: in get_agent_health
    health_data = await monitoring_service.get_agent_health(db, agent_id)
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
---------------------------- Captured stderr setup -----------------------------
2025-11-19 22:10:20.820 | INFO     | main:lifespan:35 - Starting DeepAgents Control Platform API
2025-11-19 22:10:20.820 | INFO     | main:lifespan:36 - Environment: testing
2025-11-19 22:10:20.820 | INFO     | main:lifespan:37 - Version: 1.0.0
2025-11-19 22:10:20.822 | INFO     | main:lifespan:43 - Database connection successful
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:20.831 | ERROR    | core.rate_limit:check_rate_limit:163 - Rate limit check error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:20.834 | ERROR    | core.middleware:dispatch:92 - Request error: GET /api/v1/monitoring/agents/health failed after 0.00s: Function.__init__() got an unexpected keyword argument 'else_'
2025-11-19 22:10:20.834 | ERROR    | main:generic_exception_handler:170 - Unexpected error on http://testserver/api/v1/monitoring/agents/health?agent_id=1: Function.__init__() got an unexpected keyword argument 'else_'
--------------------------- Captured stderr teardown ---------------------------
2025-11-19 22:10:21.108 | INFO     | main:lifespan:51 - Shutting down DeepAgents Control Platform API
2025-11-19 22:10:21.109 | INFO     | main:lifespan:53 - Database connections closed
_______ TestPasswordStrengthCalculation.test_score_ranges_are_consistent _______
tests/test_core/test_password_validator.py:239: in test_score_ranges_are_consistent
    assert strength == expected_strength or strength.value in [
E   AssertionError: assert (<PasswordStre...: 'very_weak'> == <PasswordStre...IUM: 'medium'>
E     
E     - medium
E     + very_weak or 'very_weak' in ['strong', 'very_strong'])
E    +  where 'very_weak' = <PasswordStrength.VERY_WEAK: 'very_weak'>.value
__________ TestPathTraversalDetection.test_parent_directory_in_middle __________
tests/test_core/test_path_validator.py:115: in test_parent_directory_in_middle
    assert ".." in error
E   AssertionError: assert '..' in 'Path traversal detected: \\.\\./'
___________ TestPathSanitization.test_sanitize_removes_leading_slash ___________
tests/test_core/test_path_validator.py:173: in test_sanitize_removes_leading_slash
    sanitized = validator.sanitize("/subdir/file.txt")
core/path_validator.py:150: in sanitize
    raise PathTraversalError(error)
E   core.path_validator.PathTraversalError: Absolute paths are not allowed
_______________ TestRealWorldAttackVectors.test_windows_unc_path _______________
tests/test_core/test_path_validator.py:341: in test_windows_unc_path
    assert valid is False
E   assert True is False
_________ TestSecurityAssertions.test_normalized_path_stays_in_sandbox _________
tests/test_core/test_path_validator.py:414: in test_normalized_path_stays_in_sandbox
    safe_path = validator.get_safe_path(path)
core/path_validator.py:204: in get_safe_path
    sanitized = self.sanitize(path)
core/path_validator.py:150: in sanitize
    raise PathTraversalError(error)
E   core.path_validator.PathTraversalError: Path traversal detected: \.\./
_______________________ test_create_agent_with_subagents _______________________
tests/test_deepagents_integration/test_factory.py:264: in test_create_agent_with_subagents
    from deepagents.middleware.subagents import SubAgent
venv/lib/python3.13/site-packages/deepagents/__init__.py:3: in <module>
    from deepagents.graph import create_deep_agent
venv/lib/python3.13/site-packages/deepagents/graph.py:22: in <module>
    from deepagents.middleware.patch_tool_calls import PatchToolCallsMiddleware
venv/lib/python3.13/site-packages/deepagents/middleware/__init__.py:4: in <module>
    from deepagents.middleware.resumable_shell import ResumableShellToolMiddleware
venv/lib/python3.13/site-packages/deepagents/middleware/resumable_shell.py:8: in <module>
    from langchain.agents.middleware.shell_tool import (
E   ImportError: cannot import name '_PersistentShellTool' from 'langchain.agents.middleware.shell_tool' (/home/user/deeps/backend/venv/lib/python3.13/site-packages/langchain/agents/middleware/shell_tool.py)
_______________________ test_subagent_delegation_config ________________________
tests/test_deepagents_integration/test_factory.py:288: in test_subagent_delegation_config
    from deepagents.middleware.subagents import SubAgent
venv/lib/python3.13/site-packages/deepagents/__init__.py:3: in <module>
    from deepagents.graph import create_deep_agent
venv/lib/python3.13/site-packages/deepagents/graph.py:22: in <module>
    from deepagents.middleware.patch_tool_calls import PatchToolCallsMiddleware
venv/lib/python3.13/site-packages/deepagents/middleware/__init__.py:4: in <module>
    from deepagents.middleware.resumable_shell import ResumableShellToolMiddleware
venv/lib/python3.13/site-packages/deepagents/middleware/resumable_shell.py:8: in <module>
    from langchain.agents.middleware.shell_tool import (
E   ImportError: cannot import name '_PersistentShellTool' from 'langchain.agents.middleware.shell_tool' (/home/user/deeps/backend/venv/lib/python3.13/site-packages/langchain/agents/middleware/shell_tool.py)
_________ TestExecutionTimeSeries.test_get_execution_time_series_daily _________
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlite3.OperationalError: no such function: date_trunc

The above exception was the direct cause of the following exception:
tests/test_services/test_analytics_service.py:114: in test_get_execution_time_series_daily
    result = await analytics_service.get_execution_time_series(
core/cache.py:141: in wrapper
    result = await func(*args, **kwargs)
services/analytics_service.py:95: in get_execution_time_series
    result = await db.execute(query)
venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such function: date_trunc
E   [SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
E   FROM executions 
E   WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL GROUP BY bucket ORDER BY bucket]
E   [parameters: ('day', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-17 21:10:44.274126', '2025-11-19 23:10:44.274126')]
E   (Background on this error at: https://sqlalche.me/e/20/e3q8)
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:44.278 | WARNING  | core.cache:_make_cache_key:83 - Failed to serialize cache key arguments: Circular reference detected
2025-11-19 22:10:44.279 | WARNING  | core.cache:wrapper:137 - Redis cache read error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
___ TestExecutionTimeSeries.test_get_execution_time_series_filtered_by_agent ___
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlite3.OperationalError: no such function: date_trunc

The above exception was the direct cause of the following exception:
tests/test_services/test_analytics_service.py:201: in test_get_execution_time_series_filtered_by_agent
    result = await analytics_service.get_execution_time_series(
core/cache.py:141: in wrapper
    result = await func(*args, **kwargs)
services/analytics_service.py:95: in get_execution_time_series
    result = await db.execute(query)
venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such function: date_trunc
E   [SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
E   FROM executions 
E   WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL AND executions.agent_id = ? GROUP BY bucket ORDER BY bucket]
E   [parameters: ('day', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-19 21:10:44.685546', '2025-11-19 23:10:44.685546', 1)]
E   (Background on this error at: https://sqlalche.me/e/20/e3q8)
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:44.687 | WARNING  | core.cache:_make_cache_key:83 - Failed to serialize cache key arguments: Circular reference detected
2025-11-19 22:10:44.688 | WARNING  | core.cache:wrapper:137 - Redis cache read error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
_________ TestExecutionTimeSeries.test_get_execution_time_series_empty _________
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlite3.OperationalError: no such function: date_trunc

The above exception was the direct cause of the following exception:
tests/test_services/test_analytics_service.py:218: in test_get_execution_time_series_empty
    result = await analytics_service.get_execution_time_series(
core/cache.py:141: in wrapper
    result = await func(*args, **kwargs)
services/analytics_service.py:95: in get_execution_time_series
    result = await db.execute(query)
venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
venv/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:48: in execute
    await self._execute(self._cursor.execute, sql, parameters)
venv/lib/python3.13/site-packages/aiosqlite/cursor.py:40: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
venv/lib/python3.13/site-packages/aiosqlite/core.py:132: in _execute
    return await future
venv/lib/python3.13/site-packages/aiosqlite/core.py:115: in run
    result = function()
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such function: date_trunc
E   [SQL: SELECT date_trunc(?, executions.started_at) AS bucket, count(*) AS total, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS successful, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS failed, sum(CASE WHEN (executions.status = ?) THEN ? ELSE ? END) AS cancelled, avg(CASE WHEN (executions.status = ? AND executions.completed_at IS NOT NULL AND executions.started_at IS NOT NULL) THEN CAST(STRFTIME('%s', executions.completed_at - executions.started_at) AS INTEGER) END) AS avg_duration, sum(executions.total_tokens) AS total_tokens, sum(executions.estimated_cost) AS estimated_cost 
E   FROM executions 
E   WHERE executions.started_at >= ? AND executions.started_at <= ? AND executions.started_at IS NOT NULL GROUP BY bucket ORDER BY bucket]
E   [parameters: ('day', 'completed', 1, 0, 'failed', 1, 0, 'cancelled', 1, 0, 'completed', '2025-11-12 22:10:45.094798', '2025-11-19 22:10:45.094798')]
E   (Background on this error at: https://sqlalche.me/e/20/e3q8)
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:45.094 | WARNING  | core.cache:_make_cache_key:83 - Failed to serialize cache key arguments: Circular reference detected
2025-11-19 22:10:45.096 | WARNING  | core.cache:wrapper:137 - Redis cache read error: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
__________________ test_create_user_duplicate_username_fails ___________________
tests/test_services/test_auth_service.py:139: in test_create_user_duplicate_username_fails
    user_data1 = UserRegister(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for UserRegister
E   password
E     Value error, Password is too common. Please choose a more unique password [type=value_error, input_value='Password123', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.12/v/value_error
____________________ test_create_user_duplicate_email_fails ____________________
tests/test_services/test_auth_service.py:161: in test_create_user_duplicate_email_fails
    user_data1 = UserRegister(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for UserRegister
E   password
E     Value error, Password is too common. Please choose a more unique password [type=value_error, input_value='Password123', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.12/v/value_error
____________________ test_authenticate_user_account_lockout ____________________
tests/test_services/test_auth_service.py:253: in test_authenticate_user_account_lockout
    with pytest.raises(ValueError, match="Account has been locked"):
E   Failed: DID NOT RAISE <class 'ValueError'>
----------------------------- Captured stderr call -----------------------------
2025-11-19 22:10:50.273 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:50.539 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:50.539 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'lockoutuser'. 5 attempts remaining.
2025-11-19 22:10:50.540 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:50.805 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:50.805 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'lockoutuser'. 5 attempts remaining.
2025-11-19 22:10:50.806 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:51.072 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:51.072 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'lockoutuser'. 5 attempts remaining.
2025-11-19 22:10:51.073 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:51.340 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:51.340 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'lockoutuser'. 5 attempts remaining.
2025-11-19 22:10:51.341 | WARNING  | services.lockout_service:is_locked:105 - Redis error in is_locked: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:51.606 | WARNING  | services.lockout_service:record_failed_attempt:210 - Redis error in record_failed_attempt: Error 111 connecting to localhost:6379. Connect call failed ('127.0.0.1', 6379).
2025-11-19 22:10:51.606 | WARNING  | services.auth_service:authenticate_user:137 - Failed login attempt for user 'lockoutuser'. 5 attempts remaining.
_______________ TestAgentHealth.test_get_agent_health_all_agents _______________
tests/test_services/test_monitoring_service.py:159: in test_get_agent_health_all_agents
    health_data = await monitoring_service.get_agent_health(db_session)
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
______________ TestAgentHealth.test_get_agent_health_single_agent ______________
tests/test_services/test_monitoring_service.py:215: in test_get_agent_health_single_agent
    health_data = await monitoring_service.get_agent_health(
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
_______________ TestAgentHealth.test_agent_health_no_executions ________________
tests/test_services/test_monitoring_service.py:305: in test_agent_health_no_executions
    health_data = await monitoring_service.get_agent_health(db_session)
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
_____________ TestExecutionStatistics.test_get_executions_by_agent _____________
tests/test_services/test_monitoring_service.py:456: in test_get_executions_by_agent
    health_data = await monitoring_service.get_agent_health(db_session)
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
__________________ TestUsageAnalytics.test_get_usage_by_agent __________________
tests/test_services/test_monitoring_service.py:569: in test_get_usage_by_agent
    health_data = await monitoring_service.get_agent_health(db_session)
services/monitoring_service.py:160: in get_agent_health
    func.case((Execution.status == "completed", 1), else_=0)
venv/lib/python3.13/site-packages/sqlalchemy/sql/functions.py:976: in __call__
    return Function(
E   TypeError: Function.__init__() got an unexpected keyword argument 'else_'
=========================== short test summary info ============================
FAILED tests/test_api/test_agents.py::test_delete_agent_endpoint_idempotent
FAILED tests/test_api/test_analytics_endpoints.py::TestTimeSeriesEndpoint::test_get_execution_time_series_endpoint
FAILED tests/test_api/test_analytics_endpoints.py::TestTimeSeriesEndpoint::test_get_execution_time_series_endpoint_with_agent_filter
FAILED tests/test_api/test_auth.py::test_get_lockout_status_with_failed_attempts
FAILED tests/test_api/test_auth.py::test_get_lockout_status_locked_account - ...
FAILED tests/test_api/test_auth.py::test_get_lockout_status_requires_authentication
FAILED tests/test_api/test_auth.py::test_unlock_locked_account - assert False...
FAILED tests/test_api/test_auth.py::test_unlock_already_unlocked_account - as...
FAILED tests/test_api/test_auth.py::test_unlock_nonexistent_user - assert 403...
FAILED tests/test_api/test_auth.py::test_login_locked_account_returns_429 - a...
FAILED tests/test_api/test_auth.py::test_successful_login_clears_failed_attempts
FAILED tests/test_api/test_executions.py::TestExecutionAPIEndpoints::test_list_executions_endpoint
FAILED tests/test_api/test_executions.py::TestExecutionAPIEndpoints::test_list_executions_with_filters
FAILED tests/test_api/test_monitoring.py::TestAgentHealthEndpoint::test_get_agent_health_endpoint
FAILED tests/test_api/test_monitoring.py::TestAgentHealthEndpoint::test_get_agent_health_endpoint_with_agent_id
FAILED tests/test_core/test_password_validator.py::TestPasswordStrengthCalculation::test_score_ranges_are_consistent
FAILED tests/test_core/test_path_validator.py::TestPathTraversalDetection::test_parent_directory_in_middle
FAILED tests/test_core/test_path_validator.py::TestPathSanitization::test_sanitize_removes_leading_slash
FAILED tests/test_core/test_path_validator.py::TestRealWorldAttackVectors::test_windows_unc_path
FAILED tests/test_core/test_path_validator.py::TestSecurityAssertions::test_normalized_path_stays_in_sandbox
FAILED tests/test_deepagents_integration/test_factory.py::test_create_agent_with_subagents
FAILED tests/test_deepagents_integration/test_factory.py::test_subagent_delegation_config
FAILED tests/test_services/test_analytics_service.py::TestExecutionTimeSeries::test_get_execution_time_series_daily
FAILED tests/test_services/test_analytics_service.py::TestExecutionTimeSeries::test_get_execution_time_series_filtered_by_agent
FAILED tests/test_services/test_analytics_service.py::TestExecutionTimeSeries::test_get_execution_time_series_empty
FAILED tests/test_services/test_auth_service.py::test_create_user_duplicate_username_fails
FAILED tests/test_services/test_auth_service.py::test_create_user_duplicate_email_fails
FAILED tests/test_services/test_auth_service.py::test_authenticate_user_account_lockout
FAILED tests/test_services/test_monitoring_service.py::TestAgentHealth::test_get_agent_health_all_agents
FAILED tests/test_services/test_monitoring_service.py::TestAgentHealth::test_get_agent_health_single_agent
FAILED tests/test_services/test_monitoring_service.py::TestAgentHealth::test_agent_health_no_executions
FAILED tests/test_services/test_monitoring_service.py::TestExecutionStatistics::test_get_executions_by_agent
FAILED tests/test_services/test_monitoring_service.py::TestUsageAnalytics::test_get_usage_by_agent
=========== 33 failed, 616 passed, 195 warnings in 75.32s (0:01:15) ============
