# ============================================================================
# PostgreSQL 17 Production Configuration for DeepAgents Control Platform
# ============================================================================
#
# This configuration is optimized for production workloads with:
# - Good default settings for moderate traffic
# - Balanced performance and data safety
# - Connection pooling support
# - Appropriate logging for monitoring
#
# IMPORTANT: Adjust settings based on your server's resources
# These settings assume a server with 4GB RAM dedicated to PostgreSQL
#
# ============================================================================

# ============================================================================
# Connection Settings
# ============================================================================
# Maximum number of concurrent connections
# Default is 100, increase if you have high concurrency
# Reserve ~10 for admin connections
max_connections = 200

# Minimum number of connections to keep open (improves performance)
# PostgreSQL 17+ feature
# min_wal_size and max_wal_size handle this indirectly

# ============================================================================
# Memory Settings
# ============================================================================
# Shared buffers: Memory for caching data
# Recommendation: 25% of total RAM (1GB for 4GB system)
shared_buffers = 1GB

# Effective cache size: Estimate of OS + PostgreSQL cache
# Recommendation: 50-75% of total RAM (2.5GB for 4GB system)
effective_cache_size = 2560MB

# Maintenance work mem: Memory for maintenance operations (VACUUM, CREATE INDEX)
# Recommendation: 5-10% of RAM (256MB for 4GB system)
maintenance_work_mem = 256MB

# Work mem: Memory for sort operations and hash tables (per operation)
# Recommendation: (Total RAM / max_connections) / 2
# For 4GB RAM and 200 connections: ~10MB per operation
work_mem = 10MB

# ============================================================================
# Write Ahead Log (WAL) Settings
# ============================================================================
# WAL level: Set to replica for replication support (allows future scaling)
wal_level = replica

# Minimum size of WAL to keep
min_wal_size = 1GB

# Maximum size of WAL between checkpoints
max_wal_size = 4GB

# WAL buffers: Memory for WAL before writing to disk
# Recommendation: 16MB (default -1 auto-tunes to 1/32 of shared_buffers)
wal_buffers = 16MB

# ============================================================================
# Checkpoint Settings
# ============================================================================
# Target time between automatic WAL checkpoints
# Longer intervals = better performance, but longer recovery time
checkpoint_completion_target = 0.9

# ============================================================================
# Query Planner Settings
# ============================================================================
# Cost of a random page fetch (SSD: 1.1-2.0, HDD: 4.0)
# Using 1.1 for modern SSD
random_page_cost = 1.1

# Cost of a sequential page fetch
seq_page_cost = 1.0

# Number of query planner should consider for JOIN operations
# Higher values = better plans, but slower planning
default_statistics_target = 100

# ============================================================================
# Parallel Query Settings
# ============================================================================
# Maximum number of worker processes
# Recommendation: Number of CPU cores
max_worker_processes = 4

# Maximum number of parallel workers per query
# Recommendation: Half of CPU cores
max_parallel_workers_per_gather = 2

# Maximum total parallel workers
# Recommendation: Same as max_worker_processes
max_parallel_workers = 4

# Minimum size of table before considering parallel scan
# Default 8MB is good for most cases
min_parallel_table_scan_size = 8MB

# ============================================================================
# Autovacuum Settings
# ============================================================================
# Enable autovacuum (CRITICAL for performance)
autovacuum = on

# Maximum number of autovacuum processes
autovacuum_max_workers = 3

# Time between autovacuum runs (seconds)
autovacuum_naptime = 60s

# Fraction of table size to add to vacuum threshold
autovacuum_vacuum_scale_factor = 0.1

# Fraction of table size to add to analyze threshold
autovacuum_analyze_scale_factor = 0.05

# ============================================================================
# Logging Settings
# ============================================================================
# Where to log
logging_collector = on
log_destination = 'stderr'

# Log file naming
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Keep 7 days of logs
log_truncate_on_rotation = off

# What to log
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# Log slow queries (queries taking longer than 1 second)
log_min_duration_statement = 1000

# Log connection and disconnection
log_connections = on
log_disconnections = on

# Log lock waits longer than 1 second
log_lock_waits = on

# Log checkpoints (useful for performance tuning)
log_checkpoints = on

# Log autovacuum activity
log_autovacuum_min_duration = 0

# ============================================================================
# Statement Timeout
# ============================================================================
# Kill queries running longer than 5 minutes (prevents runaway queries)
# 0 = disabled, time in milliseconds
statement_timeout = 300000

# ============================================================================
# Lock Settings
# ============================================================================
# Maximum time to wait for a lock (30 seconds)
lock_timeout = 30000

# Time to wait for idle transaction before killing (5 minutes)
idle_in_transaction_session_timeout = 300000

# ============================================================================
# Locale and Formatting
# ============================================================================
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# ============================================================================
# Connection Pooling Support
# ============================================================================
# Allow prepared transactions (required for some poolers)
# max_prepared_transactions = 0  # Disabled by default

# ============================================================================
# Performance Monitoring
# ============================================================================
# Track query statistics
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# Track IO timing (slight overhead, but useful for diagnostics)
track_io_timing = on

# Track function call counts and times
track_functions = all

# ============================================================================
# Security Settings
# ============================================================================
# Require SSL for connections (uncomment for production)
# ssl = on
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'

# Password encryption method (scram-sha-256 is most secure)
password_encryption = scram-sha-256
